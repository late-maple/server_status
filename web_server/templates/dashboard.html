<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœåŠ¡å™¨çŠ¶æ€é¢æ¿</title>
    <link rel="stylesheet" href="../static/server-status.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            
            min-height: 100vh;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .servers-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .server-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .server-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }
        .server-name {
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        .status-indicator {
            font-size: 1.5em;
        }
        .online {
            color: #28a745;
        }
        .offline {
            color: #dc3545;
        }
        .status-item {
            margin: 12px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .label {
            font-weight: 600;
            color: #555;
        }
        .value {
            color: #333;
            font-weight: 500;
        }
        .players-list, .bots-list-content {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }
        .player-tag, .bot-tag {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
            background-color: #667eea;
            color: white;
        }
        .bot-tag {
            background-color: #f093fb;
        }
        .bots-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #ddd;
        }
        .bots-toggle {
            background-color: #4facfe;
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(79, 172, 254, 0.3);
        }
        .bots-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
        }
        .bots-toggle:active {
            transform: translateY(0);
        }
        .bots-list {
            margin-top: 12px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
            max-height: 150px;
            overflow-y: auto;
        }
        .hidden {
            display: none;
        }
        .empty-list {
            color: #888;
            font-style: italic;
            font-size: 0.9em;
        }
        .update-time {
                    font-size: 0.8em;
                    color: #888;
                    text-align: right;
                    margin-top: 10px;
                }
                /* æ’è¡Œæ¦œç»„ä»¶æ ·å¼ */
                .leaderboard-container {
                    max-width: 800px;
                    margin: 0 auto;
                    background: rgba(255, 255, 255, 0.15);
                    border-radius: 12px;
                    padding: 20px;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
                    backdrop-filter: blur(4px);
                    border: 1px solid rgba(255,255,255,0.2);
                }
                .leaderboard-item {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 15px;
                    border-bottom: 1px solid rgba(255,255,255,0.1);
                }
                .leaderboard-item:last-child {
                    border-bottom: none;
                }
                .player-rank {
                    font-size: 1.5em;
                    font-weight: bold;
                    color: #667eea;
                    min-width: 40px;
                }
                .player-name {
                    font-size: 1.2em;
                    font-weight: 600;
                    color: white;
                    flex-grow: 1;
                }
                .player-server {
                    font-size: 1em;
                    color: #ccc;
                    min-width: 150px;
                }
                .player-last-played {
                    font-size: 1em;
                    color: #ccc;
                    min-width: 200px;
                }
                .player-time-since-last-played {
                    font-size: 1.1em;
                    font-weight: 600;
                    color: #e74c3c;
                    min-width: 150px;
                }
                .player-total-time, .player-weekly-time, .player-monthly-time {
                    font-size: 1em;
                    color: #ccc;
                    min-width: 150px;
                }
                .rank-1 .player-rank {
                    color: #ffd700;
                }
                .rank-2 .player-rank {
                    color: #c0c0c0;
                }
                .rank-3 .player-rank {
                    color: #cd7f32;
                }
                .loading {
                    text-align: center;
                    font-size: 1.2em;
                    color: #ccc;
                    padding: 20px;
                }
                .error-message {
                    text-align: center;
                    font-size: 1.2em;
                    color: #e74c3c;
                    padding: 20px;
                }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ® æœåŠ¡å™¨çŠ¶æ€ç›‘æ§é¢æ¿</h1>
    </div>
    
    <div class="servers-container" id="serversContainer">
        <!-- æœåŠ¡å™¨å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        <div class="loading">åŠ è½½ä¸­...</div>
    </div>

    <!-- ç©å®¶æŸ¥è¯¢ç»„ä»¶ -->
    <div style="max-width: 1200px; margin: 30px auto 0; padding: 20px;">
        <div class="header" style="margin-bottom: 20px;">
            <h2 style="margin: 0; color: white;">ğŸ” æŸ¥è¯¢ç©å®¶æ¸¸æˆæ—¶é•¿</h2>
            <p style="margin: 10px 0 0; color: #ccc;">è¾“å…¥ç©å®¶åç§°æŸ¥çœ‹å…¶åœ¨å„æœåŠ¡å™¨çš„æ¸¸æˆç»Ÿè®¡ä¿¡æ¯å’Œå†å²è®°å½•</p>
        </div>
        <div id="playerSearchContainer" style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
            <input type="text" id="playerNameInput" placeholder="è¾“å…¥ç©å®¶åç§°æŸ¥è¯¢æ¸¸æˆæ—¶é•¿" style="padding: 12px 20px; border-radius: 25px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.15); color: white; backdrop-filter: blur(5px); font-size: 1em; min-width: 300px; outline: none;">
            <button id="searchPlayerBtn" onclick="searchPlayer()" style="padding: 12px 25px; border-radius: 25px; border: none; background: rgba(79, 172, 254, 0.3); color: white; backdrop-filter: blur(5px); font-size: 1em; cursor: pointer; transition: all 0.3s ease;">ğŸ” æŸ¥è¯¢</button>
            <button id="clearSearchBtn" onclick="clearSearch()" style="padding: 12px 25px; border-radius: 25px; border: none; background: rgba(220, 53, 69, 0.3); color: white; backdrop-filter: blur(5px); font-size: 1em; cursor: pointer; transition: all 0.3s ease; display: none;">ğŸ—‘ï¸ æ¸…ç©º</button>
        </div>
        <!-- ç©å®¶æŸ¥è¯¢ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
                <div id="playerSearchResult" style="display: none;">
                    <!-- æŸ¥è¯¢ç»“æœå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        
            <!-- æ’è¡Œæ¦œç»„ä»¶ -->
            <div style="max-width: 1200px; margin: 30px auto 0; padding: 20px;">
                <div class="header" style="margin-bottom: 20px;">
                    <h2 style="margin: 0; color: white;">ğŸ† ç©å®¶æ’è¡Œæ¦œ</h2>
                    <p style="margin: 10px 0 0; color: #ccc;">æŸ¥çœ‹æœåŠ¡å™¨ç©å®¶æ’è¡Œæ¦œ</p>
                </div>
                
                <!-- æ’è¡Œæ¦œæ ‡ç­¾é¡µ -->
                <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
                    <button id="lastPlayedTab" onclick="showLeaderboard('lastPlayed')" style="padding: 12px 25px; border-radius: 25px; border: none; background: rgba(79, 172, 254, 0.3); color: white; backdrop-filter: blur(5px); font-size: 1em; cursor: pointer; transition: all 0.3s ease;">æ‘¸é±¼æ¦œ</button>
                </div>
                
                <div class="leaderboard-container">
                    <div id="leaderboardContent">
                        <div class="loading">åŠ è½½ä¸­...</div>
                    </div>
                </div>
            </div>

    <script>
        function formatUptime(seconds) {
           const days = Math.floor(seconds / 86400);
           const hours = Math.floor((seconds % 86400) / 3600);
           const minutes = Math.floor((seconds % 3600) / 60);
           const secs = seconds % 60;
           
           if (days > 0) {
               return days + 'å¤© ' + hours.toString().padStart(2, '0') + ':' + minutes.toString().padStart(2, '0') + ':' + secs.toString().padStart(2, '0');
           }
           return hours.toString().padStart(2, '0') + ':' + minutes.toString().padStart(2, '0') + ':' + secs.toString().padStart(2, '0');
       }

        function isServerOnline(lastUpdate) {
            if (!lastUpdate) return false;
            const lastUpdateDate = new Date(lastUpdate);
            const now = new Date();
            const diffMinutes = (now - lastUpdateDate) / (1000 * 60);
            return diffMinutes <= 6; // åˆ†é’Ÿ æ›´æ–°è®¤ä¸ºåœ¨çº¿ æ¯”æ›´æ–°é—´éš”ç¨å¤§
        }

        function toggleBots(serverId) {
           const botsList = document.getElementById('bots-' + serverId);
           const toggleBtn = document.getElementById('toggle-' + serverId);
           if (botsList.classList.contains('hidden')) {
               botsList.classList.remove('hidden');
               toggleBtn.textContent = 'éšè—å‡äººç©å®¶åˆ—è¡¨';
           } else {
               botsList.classList.add('hidden');
               toggleBtn.textContent = 'æ˜¾ç¤ºå‡äººç©å®¶åˆ—è¡¨ (' + (botsList.dataset.count || 0) + ')';
           }
       }

       function updateServerStatus() {
            // æ ¹æ®å½“å‰è®¿é—®æ–¹å¼é€‰æ‹©åˆé€‚çš„APIè·¯å¾„
            let apiUrl = '/status/api/servers';
            // å½“ç›´æ¥è®¿é—®localhost:5000æ—¶ä½¿ç”¨ç›´æ¥è·¯å¾„
            if (window.location.port === '5000') {
                apiUrl = '/api/servers';
            }

            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('serversContainer');
                    if (!data || data.code !== 200 || !data.data || Object.keys(data.data).length === 0) {
                        container.innerHTML = '<div class="server-card" style="text-align: center; grid-column: 1 / -1;"><h3>æš‚æ— æœåŠ¡å™¨æ•°æ®</h3><p>è¯·ç¡®ä¿æ’ä»¶å·²æ­£ç¡®é…ç½®å¹¶è¿è¡Œ</p></div>';
                        return;
                    }
                    
                    const serverData = data.data;
                    container.innerHTML = '';
                    
                    for (const [serverId, server] of Object.entries(serverData)) {
                        const isOnline = isServerOnline(server.last_update);
                        const card = document.createElement('div');
                        card.className = 'server-card';
                        
                        // å‡†å¤‡ç©å®¶å’Œå‡äººåˆ—è¡¨
                        const players = server.players || [];
                        const bots = server.bots || [];
                        const botCount = bots.length;
                        
                        // æ„å»ºçœŸå®ç©å®¶åˆ—è¡¨HTML
                        let playersHtml = '';
                        if (players.length > 0) {
                            playersHtml = players.map(player =>
                               '<span class="player-tag">' + player + '</span>'
                           ).join('');
                        } else {
                            playersHtml = '<span class="empty-list">å½“å‰æ²¡æœ‰çœŸå®ç©å®¶åœ¨çº¿</span>';
                        }
                        
                        // æ„å»ºå‡äººç©å®¶åˆ—è¡¨HTML
                        let botsHtml = '';
                        if (botCount > 0) {
                            botsHtml = bots.map(bot =>
                               '<span class="bot-tag">' + bot + '</span>'
                           ).join('');
                        } else {
                            botsHtml = '<span class="empty-list">å½“å‰æ²¡æœ‰å‡äººç©å®¶åœ¨çº¿</span>';
                        }
                        
                        // è·å–ç©å®¶è¯¦ç»†ä¿¡æ¯
                        // æ ¹æ®å½“å‰è®¿é—®æ–¹å¼é€‰æ‹©åˆé€‚çš„APIè·¯å¾„
                        let playersApiUrl = '/status/api/players_with_last_played?server_id=' + encodeURIComponent(serverId);
                        // å½“ç›´æ¥è®¿é—®localhost:5000æ—¶ä½¿ç”¨ç›´æ¥è·¯å¾„
                        if (window.location.port === '5000') {
                            playersApiUrl = '/api/players_with_last_played?server_id=' + encodeURIComponent(serverId);
                        }
                        
                        fetch(playersApiUrl)
                            .then(response => response.json())
                            .then(playersData => {
                                // æ£€æŸ¥å“åº”æ˜¯å¦æˆåŠŸ
                                if (playersData && playersData.code === 200) {
                                    // æ„å»ºç©å®¶è¯¦ç»†ä¿¡æ¯HTML
                                    let playersDetailHtml = '';
                                    if (playersData.data && playersData.data.length > 0) {
                                        playersDetailHtml = playersData.data.map(player =>
                                           '<div class="player-detail">' +
                                               '<span class="player-tag">' + player.player_name + '</span>' +
                                               '<span class="player-last-played">æœ€åæ¸¸æˆ: ' + (player.last_play_time || 'N/A') + '</span>' +
                                               '<span class="player-time-since-last-played">è·ç¦»ä¸Šæ¬¡æ¸¸æˆ: ' + (player.time_since_last_played_formatted || 'N/A') + '</span>' +
                                           '</div>'
                                       ).join('');
                                    } else {
                                        playersDetailHtml = '<span class="empty-list">å½“å‰æ²¡æœ‰ç©å®¶æ•°æ®</span>';
                                    }
                                    
                                    card.innerHTML =
                                       '<div class="server-name">' +
                                           '<span>' + (server.server_name || serverId) + '</span>' +
                                           '<span class="status-indicator ' + (isOnline ? 'online' : 'offline') + '">' + (isOnline ? 'â—' : 'â—‹') + '</span>' +
                                       '</div>' +
                                       '<div class="status-item">' +
                                           '<span class="label">çŠ¶æ€:</span>' +
                                           '<span class="value">' + (isOnline ? 'ğŸŸ¢ åœ¨çº¿' : 'ğŸ”´ ç¦»çº¿') + '</span>' +
                                       '</div>' +
                                       '<div class="status-item">' +
                                           '<span class="label">å†…å­˜ä½¿ç”¨ç‡:</span>' +
                                           '<span class="value">' + (server.memory_usage ? server.memory_usage.toFixed(1) + '%' : 'N/A') + '</span>' +
                                       '</div>' +
                                       '<div class="status-item">' +
                                           '<span class="label">è¿è¡Œæ—¶é—´:</span>' +
                                           '<span class="value">' + (server.uptime ? formatUptime(server.uptime) : 'N/A') + '</span>' +
                                       '</div>' +
                                       '<div class="status-item">' +
                                           '<span class="label">çœŸå®ç©å®¶:</span>' +
                                           '<span class="value">' + (server.player_count || 0) + '</span>' +
                                       '</div>' +
                                       '<div class="status-item">' +
                                           '<span class="label">ç©å®¶åˆ—è¡¨:</span>' +
                                       '</div>' +
                                       '<div class="players-list">' +
                                           playersHtml +
                                       '</div>' +
                                       '<div class="bots-section">' +
                                           '<div class="status-item">' +
                                               '<span class="label">å‡äººç©å®¶:</span>' +
                                               '<span class="value">' + botCount + '</span>' +
                                           '</div>' +
                                           '<button class="bots-toggle" id="toggle-' + serverId + '" onclick="toggleBots(\'' + serverId + '\')">' +
                                               (botCount > 0 ? 'æ˜¾ç¤ºå‡äººç©å®¶åˆ—è¡¨ (' + botCount + ')' : 'æš‚æ— å‡äººç©å®¶') +
                                           '</button>' +
                                           '<div class="bots-list hidden" id="bots-' + serverId + '" data-count="' + botCount + '">' +
                                               '<div class="bots-list-content">' +
                                                   botsHtml +
                                               '</div>' +
                                           '</div>' +
                                       '</div>' +
                                       '<div class="update-time">' +
                                           'æœ€åæ›´æ–°: ' + (server.last_update ? new Date(server.last_update).toLocaleString('zh-CN') : 'N/A') +
                                       '</div>';
                                } else {
                                    // å¦‚æœè·å–ç©å®¶è¯¦ç»†ä¿¡æ¯å¤±è´¥ï¼Œä»ç„¶æ˜¾ç¤ºåŸºæœ¬æœåŠ¡å™¨ä¿¡æ¯
                                    card.innerHTML =
                                       '<div class="server-name">' +
                                           '<span>' + (server.server_name || serverId) + '</span>' +
                                           '<span class="status-indicator ' + (isOnline ? 'online' : 'offline') + '">' + (isOnline ? 'â—' : 'â—‹') + '</span>' +
                                       '</div>' +
                                       '<div class="status-item">' +
                                           '<span class="label">çŠ¶æ€:</span>' +
                                           '<span class="value">' + (isOnline ? 'ğŸŸ¢ åœ¨çº¿' : 'ğŸ”´ ç¦»çº¿') + '</span>' +
                                       '</div>' +
                                       '<div class="status-item">' +
                                           '<span class="label">å†…å­˜ä½¿ç”¨ç‡:</span>' +
                                           '<span class="value">' + (server.memory_usage ? server.memory_usage.toFixed(1) + '%' : 'N/A') + '</span>' +
                                       '</div>' +
                                       '<div class="status-item">' +
                                           '<span class="label">è¿è¡Œæ—¶é—´:</span>' +
                                           '<span class="value">' + (server.uptime ? formatUptime(server.uptime) : 'N/A') + '</span>' +
                                       '</div>' +
                                       '<div class="status-item">' +
                                           '<span class="label">çœŸå®ç©å®¶:</span>' +
                                           '<span class="value">' + (server.player_count || 0) + '</span>' +
                                       '</div>' +
                                       '<div class="status-item">' +
                                           '<span class="label">ç©å®¶åˆ—è¡¨:</span>' +
                                       '</div>' +
                                       '<div class="players-list">' +
                                           playersHtml +
                                       '</div>' +
                                       '<div class="bots-section">' +
                                           '<div class="status-item">' +
                                               '<span class="label">å‡äººç©å®¶:</span>' +
                                               '<span class="value">' + botCount + '</span>' +
                                           '</div>' +
                                           '<button class="bots-toggle" id="toggle-' + serverId + '" onclick="toggleBots(\'' + serverId + '\')">' +
                                               (botCount > 0 ? 'æ˜¾ç¤ºå‡äººç©å®¶åˆ—è¡¨ (' + botCount + ')' : 'æš‚æ— å‡äººç©å®¶') +
                                           '</button>' +
                                           '<div class="bots-list hidden" id="bots-' + serverId + '" data-count="' + botCount + '">' +
                                               '<div class="bots-list-content">' +
                                                   botsHtml +
                                               '</div>' +
                                           '</div>' +
                                       '</div>' +
                                       '<div class="update-time">' +
                                           'æœ€åæ›´æ–°: ' + (server.last_update ? new Date(server.last_update).toLocaleString('zh-CN') : 'N/A') +
                                       '</div>';
                                }
                            })
                            .catch(error => {
                                console.error('è·å–ç©å®¶è¯¦ç»†ä¿¡æ¯å¤±è´¥:', error);
                                // å¦‚æœè·å–ç©å®¶è¯¦ç»†ä¿¡æ¯å¤±è´¥ï¼Œä»ç„¶æ˜¾ç¤ºåŸºæœ¬æœåŠ¡å™¨ä¿¡æ¯
                                card.innerHTML =
                                   '<div class="server-name">' +
                                       '<span>' + (server.server_name || serverId) + '</span>' +
                                       '<span class="status-indicator ' + (isOnline ? 'online' : 'offline') + '">' + (isOnline ? 'â—' : 'â—‹') + '</span>' +
                                   '</div>' +
                                   '<div class="status-item">' +
                                       '<span class="label">çŠ¶æ€:</span>' +
                                       '<span class="value">' + (isOnline ? 'ğŸŸ¢ åœ¨çº¿' : 'ğŸ”´ ç¦»çº¿') + '</span>' +
                                   '</div>' +
                                   '<div class="status-item">' +
                                       '<span class="label">å†…å­˜ä½¿ç”¨ç‡:</span>' +
                                       '<span class="value">' + (server.memory_usage ? server.memory_usage.toFixed(1) + '%' : 'N/A') + '</span>' +
                                   '</div>' +
                                   '<div class="status-item">' +
                                       '<span class="label">è¿è¡Œæ—¶é—´:</span>' +
                                       '<span class="value">' + (server.uptime ? formatUptime(server.uptime) : 'N/A') + '</span>' +
                                   '</div>' +
                                   '<div class="status-item">' +
                                       '<span class="label">çœŸå®ç©å®¶:</span>' +
                                       '<span class="value">' + (server.player_count || 0) + '</span>' +
                                   '</div>' +
                                   '<div class="status-item">' +
                                       '<span class="label">ç©å®¶åˆ—è¡¨:</span>' +
                                   '</div>' +
                                   '<div class="players-list">' +
                                       playersHtml +
                                   '</div>' +
                                   '<div class="bots-section">' +
                                       '<div class="status-item">' +
                                           '<span class="label">å‡äººç©å®¶:</span>' +
                                           '<span class="value">' + botCount + '</span>' +
                                       '</div>' +
                                       '<button class="bots-toggle" id="toggle-' + serverId + '" onclick="toggleBots(\'' + serverId + '\')">' +
                                           (botCount > 0 ? 'æ˜¾ç¤ºå‡äººç©å®¶åˆ—è¡¨ (' + botCount + ')' : 'æš‚æ— å‡äººç©å®¶') +
                                       '</button>' +
                                       '<div class="bots-list hidden" id="bots-' + serverId + '" data-count="' + botCount + '">' +
                                           '<div class="bots-list-content">' +
                                               botsHtml +
                                           '</div>' +
                                       '</div>' +
                                   '</div>' +
                                   '<div class="update-time">' +
                                       'æœ€åæ›´æ–°: ' + (server.last_update ? new Date(server.last_update).toLocaleString('zh-CN') : 'N/A') +
                                   '</div>' +
                                   '<div class="error-message">' +
                                       'è·å–ç©å®¶è¯¦ç»†ä¿¡æ¯å¤±è´¥: ' + error.message +
                                   '</div>';
                            });
                        
                        container.appendChild(card);
                    }
                })
                .catch(error => {
                    console.error('è·å–æœåŠ¡å™¨çŠ¶æ€å¤±è´¥:', error);
                    document.getElementById('serversContainer').innerHTML = 
                        '<div class="server-card" style="text-align: center; grid-column: 1 / -1;">' +
                        '<h3>âŒ è·å–æ•°æ®å¤±è´¥</h3>' +
                        '<p>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œåç«¯æœåŠ¡</p>' +
                        '<p style="font-size: 0.9em; color: #888;">é”™è¯¯ä¿¡æ¯: ' + error.message + '</p>' +
                        '</div>';
                });
        }

        // åˆå§‹åŠ è½½
        updateServerStatus();
        
        // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡
        setInterval(updateServerStatus, 300000);
        
        // æŸ¥è¯¢ç©å®¶æ¸¸æˆæ—¶é•¿
        function searchPlayer() {
            const playerName = document.getElementById('playerNameInput').value.trim();
            if (!playerName) {
                alert('è¯·è¾“å…¥ç©å®¶åç§°');
                return;
            }
            
            const resultContainer = document.getElementById('playerSearchResult');
            resultContainer.style.display = 'block';
            resultContainer.innerHTML = '<div class="loading">æŸ¥è¯¢ä¸­...</div>';
            
            // æ ¹æ®å½“å‰è®¿é—®æ–¹å¼é€‰æ‹©åˆé€‚çš„APIè·¯å¾„
            let apiUrl = '/status/api/players/' + encodeURIComponent(playerName);
            // å½“ç›´æ¥è®¿é—®localhost:5000æ—¶ä½¿ç”¨ç›´æ¥è·¯å¾„
            if (window.location.port === '5000') {
                apiUrl = '/api/players/' + encodeURIComponent(playerName);
            }
            
            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    if (!data || data.code !== 200) {
                        resultContainer.innerHTML =
                            '<div class="server-card" style="text-align: center; grid-column: 1 / -1;">' +
                            '<h3>âŒ æŸ¥è¯¢å¤±è´¥</h3>' +
                            '<p>' + (data?.message || 'æœªæ‰¾åˆ°è¯¥ç©å®¶çš„æ•°æ®') + '</p>' +
                            '</div>';
                        return;
                    }
                    
                    const playerData = data.data;
                    let statsHtml = '';
                    
                    if (playerData.stats && playerData.stats.length > 0) {
                        // åˆå¹¶æ‰€æœ‰æœåŠ¡å™¨çš„æ•°æ®
                        let totalPlayTime = 0;
                        let totalSessions = 0;
                        let lastPlayTime = null;
                        
                        playerData.stats.forEach(stat => {
                            totalPlayTime += (stat.total_play_time !== null && stat.total_play_time !== undefined) ? stat.total_play_time : 0;
                            totalSessions += stat.total_sessions || 0;
                            
                            // è·å–æœ€æ–°çš„æ¸¸æˆæ—¶é—´
                            if (stat.last_play_time) {
                                if (!lastPlayTime || new Date(stat.last_play_time) > new Date(lastPlayTime)) {
                                    lastPlayTime = stat.last_play_time;
                                }
                            }
                        });
                        
                        statsHtml = '<div style="margin-top: 20px;">' +
                                   '<h3 style="color: white; text-align: center; margin-bottom: 15px;">ğŸ“Š ç©å®¶ç»Ÿè®¡ä¿¡æ¯</h3>' +
                                   '<div class="server-card" style="margin-bottom: 15px;">' +
                                   '<div class="status-item">' +
                                   '<span class="label">æ€»æ¸¸æˆæ—¶é•¿:</span>' +
                                   '<span class="value">' + formatDuration(totalPlayTime) + '</span>' +
                                   '</div>' +
                                   '<div class="status-item">' +
                                   '<span class="label">æ€»ç™»å½•æ¬¡æ•°:</span>' +
                                   '<span class="value">' + totalSessions + '</span>' +
                                   '</div>' +
                                   '<div class="status-item">' +
                                   '<span class="label">æœ€åæ¸¸æˆæ—¶é—´:</span>' +
                                   '<span class="value">' + (lastPlayTime || 'N/A') + '</span>' +
                                   '</div>' +
                                   '</div>' +
                                   '</div>';
                                   
                        // å¦‚æœéœ€è¦æ˜¾ç¤ºå„æœåŠ¡å™¨çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¯ä»¥æ·»åŠ ä¸€ä¸ªå±•å¼€/æ”¶èµ·çš„åŠŸèƒ½
                        if (playerData.stats.length > 1) {
                            statsHtml += '<div style="margin-top: 10px; text-align: center;">' +
                                        '<button onclick="toggleServerDetails(this)" style="background: rgba(79, 172, 254, 0.3); color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer;">æ˜¾ç¤ºå„æœåŠ¡å™¨è¯¦ç»†ä¿¡æ¯</button>' +
                                        '<div id="serverDetails" style="display: none; margin-top: 15px;">';
                            
                            playerData.stats.forEach(stat => {
                                statsHtml += '<div class="server-card" style="margin-bottom: 10px;">' +
                                            '<h4 style="margin-top: 0; color: white;">' + (stat.server_name || stat.server_id || 'æœªçŸ¥æœåŠ¡å™¨') + '</h4>' +
                                            '<div class="status-item">' +
                                            '<span class="label">æ¸¸æˆæ—¶é•¿:</span>' +
                                            '<span class="value">' + ((stat.total_play_time !== null && stat.total_play_time !== undefined) ? formatDuration(stat.total_play_time) : 'N/A') + '</span>' +
                                            '</div>' +
                                            '<div class="status-item">' +
                                            '<span class="label">ç™»å½•æ¬¡æ•°:</span>' +
                                            '<span class="value">' + (stat.total_sessions || 0) + '</span>' +
                                            '</div>' +
                                            '<div class="status-item">' +
                                            '<span class="label">æœ€åæ¸¸æˆ:</span>' +
                                            '<span class="value">' + (stat.last_play_time || 'N/A') + '</span>' +
                                            '</div>' +
                                            '</div>';
                            });
                            
                            statsHtml += '</div></div>';
                        }
                    }
                    
                    let recordsHtml = '';
                    if (playerData.records && playerData.records.length > 0) {
                        recordsHtml = '<div style="margin-top: 20px;">' +
                                     '<h3 style="color: white; text-align: center; margin-bottom: 15px;">ğŸ“‹ æœ€è¿‘æ¸¸æˆè®°å½•</h3>' +
                                     '<div class="server-card">';
                        playerData.records.slice(0, 10).forEach(record => {
                            recordsHtml +=
                                '<div style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 10px;">' +
                                '<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">' +
                                '<span style="font-weight: bold;">' + (record.server_name || record.server_id || 'æœªçŸ¥æœåŠ¡å™¨') + '</span>' +
                                '<span>' + (record.play_duration !== null && record.play_duration !== undefined ? formatDuration(record.play_duration) : 'è¿›è¡Œä¸­') + '</span>' +
                                '</div>' +
                                '<div style="display: flex; justify-content: space-between; font-size: 0.9em; color: #ccc;">' +
                                '<span>ç™»å½•: ' + (record.login_date || 'N/A') + '</span>' +
                                '<span>ç™»å‡º: ' + (record.logout_date || (record.play_duration === null || record.play_duration === undefined ? 'è¿›è¡Œä¸­' : 'N/A')) + '</span>' +
                                '</div>' +
                                '</div>';
                        });
                        recordsHtml += '</div></div>';
                    }
                    
                    resultContainer.innerHTML =
                        '<div class="server-card">' +
                        '<div style="text-align: center; margin-bottom: 20px;">' +
                        '<h2 style="color: white; margin: 0;">ç©å®¶: ' + playerData.player_name + '</h2>' +
                        '</div>' +
                        statsHtml +
                        recordsHtml +
                        '</div>';
                    
                    // æ˜¾ç¤ºæ¸…ç©ºæŒ‰é’®
                    document.getElementById('clearSearchBtn').style.display = 'inline-block';
                })
                .catch(error => {
                    console.error('æŸ¥è¯¢ç©å®¶å¤±è´¥:', error);
                    resultContainer.innerHTML =
                        '<div class="server-card" style="text-align: center; grid-column: 1 / -1;">' +
                        '<h3>âŒ æŸ¥è¯¢å¤±è´¥</h3>' +
                        '<p>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œåç«¯æœåŠ¡</p>' +
                        '<p style="font-size: 0.9em; color: #888;">é”™è¯¯ä¿¡æ¯: ' + error.message + '</p>' +
                        '</div>';
                });
        }
        
        // æ¸…ç©ºæŸ¥è¯¢ç»“æœ
        function clearSearch() {
            document.getElementById('playerNameInput').value = '';
            document.getElementById('playerSearchResult').style.display = 'none';
            document.getElementById('playerSearchResult').innerHTML = '';
            document.getElementById('clearSearchBtn').style.display = 'none';
        }
        
        // æ”¯æŒå›è½¦é”®æŸ¥è¯¢
        document.getElementById('playerNameInput').addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        searchPlayer();
                    }
                });
                
                // åˆ‡æ¢æ˜¾ç¤ºæœåŠ¡å™¨è¯¦ç»†ä¿¡æ¯
                function toggleServerDetails(button) {
                    const details = document.getElementById('serverDetails');
                    if (details.style.display === 'none') {
                        details.style.display = 'block';
                        button.textContent = 'éšè—å„æœåŠ¡å™¨è¯¦ç»†ä¿¡æ¯';
                    } else {
                        details.style.display = 'none';
                        button.textContent = 'æ˜¾ç¤ºå„æœåŠ¡å™¨è¯¦ç»†ä¿¡æ¯';
                    }
                }
                
                // æ’è¡Œæ¦œåŠŸèƒ½
                function formatDuration(seconds) {
                    if (seconds === null || seconds === undefined) {
                        return "N/A";
                    }
                    
                    const hours = Math.floor(seconds / 3600);
                    const minutes = Math.floor((seconds % 3600) / 60);
                    const secs = Math.floor(seconds % 60);
                    
                    if (hours > 0) {
                        return `${hours}å°æ—¶${minutes}åˆ†é’Ÿ${secs}ç§’`;
                    } else if (minutes > 0) {
                        return `${minutes}åˆ†é’Ÿ${secs}ç§’`;
                    } else {
                        return `${secs}ç§’`;
                    }
                }

                
                // æ’è¡Œæ¦œåŠŸèƒ½
                function formatDuration(seconds) {
                    if (seconds === null || seconds === undefined) {
                        return "N/A";
                    }
                    
                    const hours = Math.floor(seconds / 3600);
                    const minutes = Math.floor((seconds % 3600) / 60);
                    const secs = Math.floor(seconds % 60);
                    
                    if (hours > 0) {
                        return `${hours}å°æ—¶${minutes}åˆ†é’Ÿ${secs}ç§’`;
                    } else if (minutes > 0) {
                        return `${minutes}åˆ†é’Ÿ${secs}ç§’`;
                    } else {
                        return `${secs}ç§’`;
                    }
                }
                
                // å½“å‰æ˜¾ç¤ºçš„æ¦œå•ç±»å‹
                let currentLeaderboard = 'lastPlayed';
                
                function showLeaderboard(type) {
                    currentLeaderboard = type;
                    
                    // æ›´æ–°æ ‡ç­¾é¡µæ ·å¼
                    document.getElementById('lastPlayedTab').style.background = type === 'lastPlayed' ? 'rgba(79, 172, 254, 0.5)' : 'rgba(79, 172, 254, 0.3)';
                    document.getElementById('weeklyTab').style.background = type === 'weekly' ? 'rgba(102, 126, 234, 0.5)' : 'rgba(102, 126, 234, 0.3)';
                    document.getElementById('monthlyTab').style.background = type === 'monthly' ? 'rgba(240, 147, 251, 0.5)' : 'rgba(240, 147, 251, 0.3)';
                    
                    // åŠ è½½å¯¹åº”æ¦œå•æ•°æ®
                    updateLeaderboard();
                }
                
                function updateLeaderboard() {
    let apiUrl, title;
    
    // æ ¹æ®å½“å‰è®¿é—®æ–¹å¼é€‰æ‹©åˆé€‚çš„APIè·¯å¾„
    let baseApiUrl = '/status/api/players/leaderboard';
    // å½“ç›´æ¥è®¿é—®localhost:5000æ—¶ä½¿ç”¨ç›´æ¥è·¯å¾„
    if (window.location.port === '5000') {
        baseApiUrl = '/api/players/leaderboard';
    }
    
    // é»˜è®¤è¿‡æ»¤å‡äºº
    const filterBotsParam = 'filter_bots=true';
    
    switch(currentLeaderboard) {
        case 'weekly':
            apiUrl = baseApiUrl + '/weekly?' + filterBotsParam;
            title = 'æ¸¸æˆæ—¶é•¿å‘¨æ¦œ';
            break;
        case 'monthly':
            apiUrl = baseApiUrl + '/monthly?' + filterBotsParam;
            title = 'æ¸¸æˆæ—¶é•¿æœˆæ¦œ';
            break;
        default:
            apiUrl = baseApiUrl + '?' + filterBotsParam;  // é»˜è®¤è¿‡æ»¤å‡äººç©å®¶
            title = 'æ‘¸é±¼æ¦œ';
    }
    
    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('leaderboardContent');
            console.log('æ’è¡Œæ¦œæ•°æ®:', data); // è°ƒè¯•ä¿¡æ¯
            
            if (!data || data.code !== 200 || !data.data || data.data.length === 0) {
                container.innerHTML = '<div class="error-message">æš‚æ— ç©å®¶æ•°æ®</div>';
                return;
            }
            
            const playersData = data.data;
            let leaderboardHtml = '';
            playersData.forEach((player, index) => {
                const rank = index + 1;
                const rankClass = rank <= 3 ? `rank-${rank}` : '';
                
                console.log('ç©å®¶æ•°æ®:', player); // è°ƒè¯•ä¿¡æ¯
                
                if (currentLeaderboard === 'weekly') {
                    leaderboardHtml +=
                        '<div class="leaderboard-item ' + rankClass + '">' +
                            '<div class="player-rank">' + rank + '</div>' +
                            '<div class="player-name">' + (player.player_name || 'æœªçŸ¥ç©å®¶') + '</div>' +
                            '<div class="player-total-time">æ€»æ—¶é•¿: ' + (player.total_play_time !== null && player.total_play_time !== undefined ? formatDuration(player.total_play_time) : 'N/A') + '</div>' +
                            '<div class="player-weekly-time">å‘¨æ—¶é•¿: ' + (player.weekly_play_time !== null && player.weekly_play_time !== undefined ? formatDuration(player.weekly_play_time) : 'N/A') + '</div>' +
                        '</div>';
                } else if (currentLeaderboard === 'monthly') {
                    leaderboardHtml +=
                        '<div class="leaderboard-item ' + rankClass + '">' +
                            '<div class="player-rank">' + rank + '</div>' +
                            '<div class="player-name">' + (player.player_name || 'æœªçŸ¥ç©å®¶') + '</div>' +
                            '<div class="player-total-time">æ€»æ—¶é•¿: ' + (player.total_play_time !== null && player.total_play_time !== undefined ? formatDuration(player.total_play_time) : 'N/A') + '</div>' +
                            '<div class="player-monthly-time">æœˆæ—¶é•¿: ' + (player.monthly_play_time !== null && player.monthly_play_time !== undefined ? formatDuration(player.monthly_play_time) : 'N/A') + '</div>' +
                        '</div>';
                    } else {
                    leaderboardHtml +=
                        '<div class="leaderboard-item ' + rankClass + '">' +
                            '<div class="player-rank">' + rank + '</div>' +
                            '<div class="player-name">' + (player.player_name || 'æœªçŸ¥ç©å®¶') + '</div>' +
                            '<div class="player-last-played">æœ€åæ¸¸æˆ: ' + (player.last_play_time || 'N/A') + '</div>' +
                            '<div class="player-time-since-last-played">è·ç¦»ä¸Šæ¬¡æ¸¸æˆ: ' + (player.time_since_last_played_formatted || 'N/A') + '</div>' +
                        '</div>';
                }
            });
            
            container.innerHTML = leaderboardHtml;
        })
        .catch(error => {
            console.error('è·å–æ’è¡Œæ¦œæ•°æ®å¤±è´¥:', error);
            document.getElementById('leaderboardContent').innerHTML =
                '<div class="error-message">è·å–æ’è¡Œæ¦œæ•°æ®å¤±è´¥: ' + error.message + '</div>';
        });
}
                
                // åˆå§‹åŠ è½½æ’è¡Œæ¦œ
                updateLeaderboard();
                
                // æ¯5åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡æ’è¡Œæ¦œ
                setInterval(updateLeaderboard, 300000);
    </script>
</body>
</html>